# 02. 테스트 피라미드: 건강한 테스트 스위트를 위한 구조적 접근

좋은 테스트 스위트(테스트 코드의 모음)를 만들려면, 단순히 테스트를 많이 작성하는 것만으로는 부족합니다. 어떤 종류의 테스트를, 얼마나 많이 작성해야 할지 전략이 필요합니다. '테스트 피라미드'는 수많은 개발자들이 인정하는 가장 효과적이고 안정적인 테스트 전략 모델입니다.

이 모델은 테스트를 **범위**, **속도**, **비용**이라는 세 가지 축을 기준으로 계층화하여, 어떻게 노력과 시간을 배분하는 것이 가장 이상적인지 알려줍니다.

![Test Pyramid](https://martinfowler.com/bliki/images/testPyramid/test-pyramid.png)
*이미지 출처: Martin Fowler*

### 피라미드의 각 계층 심층 분석

#### 1. 단위 테스트 (Unit Tests - 넓고 견고한 기반)

-   **개념**: 소프트웨어를 구성하는 가장 작은 단위—주로 함수나 메서드—가 독립적으로 올바르게 작동하는지 검증하는 테스트입니다. 여기서 핵심은 **'독립적으로(in isolation)'**입니다. 즉, 네트워크, 데이터베이스, 파일 시스템 등 외부 세계와는 완전히 단절된 상태에서 오직 코드의 논리(logic)만을 검증합니다.
-   **특징**:
    -   **가장 빠름**: 외부 요소에 의존하지 않으므로 실행 속도가 수백, 수천 개를 실행해도 몇 초밖에 걸리지 않을 정도로 매우 빠릅니다.
    -   **가장 안정적**: 외부 환경의 영향을 받지 않으므로 "어제는 됐는데 오늘은 안 되는" 식의 불안정함이 없습니다. 실패했다면 100% 코드에 문제가 있다는 의미입니다.
    -   **가장 저렴**: 작성하고 유지보수하는 비용이 가장 적게 듭니다.
    -   **정확한 피드백**: 테스트가 실패하면, 어떤 함수에 문제가 있는지 즉시 정확하게 pinpoint 할 수 있습니다.
-   **왜 가장 많아야 하는가?**: 개발자는 코드를 작성하거나 수정할 때마다 이 단위 테스트를 실행합니다. 수천 개의 테스트가 몇 초 만에 실행되면서 "방금 내가 수정한 코드가 기존의 어떤 기능도 망가뜨리지 않았다"는 엄청난 자신감과 심리적 안정감을 줍니다. 이 빠른 피드백 루프는 개발 속도를 저해하는 것이 아니라, 오히려 장기적으로는 디버깅 시간을 극적으로 줄여주어 전체 개발 속도를 향상시킵니다.

#### 2. 통합 테스트 (Integration Tests - 중간의 연결고리)

-   **개념**: 단위 테스트를 통과한 여러 개의 모듈(부품)들을 함께 묶어서 서로 상호작용이 올바르게 일어나는지 검증하는 테스트입니다. 시스템의 '연결 지점(interface)'에서 발생하는 문제를 찾는 데 중점을 둡니다.
-   **특징**:
    -   **중간 속도**: 단위 테스트보다는 느리지만, 전체 시스템을 구동하는 종단간 테스트보다는 빠릅니다. 보통 실제 데이터베이스나 외부 API의 '테스트용 버전(Test Double)'을 사용하여 테스트합니다.
    -   **더 넓은 범위**: "사용자 정보를 저장하는 서비스가, 데이터베이스 모듈을 호출하여 실제로 DB에 정보를 정확히 기록하는가?"와 같이 두 개 이상의 모듈이 협력하는 시나리오를 검증합니다.
    -   **중요한 결함 발견**: 많은 버그는 각 부품은 완벽하지만, 그 부품들을 연결했을 때 발생하는 "어긋남"에서 발생합니다. 통합 테스트는 바로 이런 종류의 결함을 찾는 데 매우 효과적입니다.
-   **왜 중간 계층인가?**: 모든 모듈의 모든 상호작용을 테스트하는 것은 비효율적입니다. 따라서 단위 테스트로 각 부품의 기능을 보장한 뒤, 핵심적인 상호작용(예: API 서버와 데이터베이스 연동)만을 통합 테스트로 검증하여 효율성을 높입니다.

#### 3. 종단간 테스트 (End-to-End Tests - 가장 뾰족한 최상층)

-   **개념**: 실제 사용자의 입장에서 전체 시스템을 관통하는 하나의 완전한 시나리오(workflow)를 처음부터 끝까지 테스트합니다. UI를 포함하여 실제 운영 환경과 거의 동일한 환경에서 진행됩니다.
-   **특징**:
    -   **가장 느림**: 실제 웹 브라우저를 띄우고, 버튼을 클릭하고, 네트워크 요청을 보내고, 데이터베이스에 접근하는 등 모든 과정을 거치므로 테스트 하나를 실행하는 데 수십 초에서 수 분이 걸릴 수 있습니다.
    -   **가장 불안정(Flaky)**: 코드의 문제가 아닌데도 네트워크 지연, 예기치 않은 UI 변경, 외부 서비스의 일시적 오류 등 다양한 외부 요인으로 인해 실패할 확률이 높습니다.
    -   **가장 비쌈**: 작성하고 유지보수하는 데 가장 많은 노력이 필요합니다. 작은 UI 변경 하나만으로도 수많은 테스트가 실패하여 수정해야 할 수 있습니다.
    -   **높은 신뢰도**: 이 테스트를 통과했다면, "우리 서비스의 핵심 기능은 실제 환경에서도 문제없이 작동한다"는 가장 강력한 확신을 얻을 수 있습니다.
-   **왜 가장 적어야 하는가?**: 위와 같은 단점들 때문에, 종단간 테스트는 우리 비즈니스에 가장 치명적인 핵심 시나리오(예: "회원가입", "상품 구매", "핵심 리포트 조회")에 대해서만 최소한으로 작성해야 합니다. 이 테스트에 너무 많이 의존하면, 테스트 스위트가 너무 느리고 불안정해져서 개발자들이 테스트 실행을 꺼리게 되는 역효과가 발생합니다.

### 테스트 피라미드를 거스르면? - 아이스크림 콘 안티패턴 (Ice Cream Cone Anti-Pattern)

피라미드를 뒤집은 모양, 즉 빠르고 저렴한 단위 테스트는 거의 없고, 대부분을 느리고 비싼 종단간 테스트와 수동 테스트에 의존하는 구조를 '아이스크림 콘 안티패턴'이라고 부릅니다. 이는 테스트 실행 시간이 너무 길어 피드백이 느리고, 작은 변경에도 테스트가 쉽게 깨져 유지보수 비용이 급증하며, 버그의 원인을 찾기 어려운 최악의 테스트 전략 중 하나입니다.

결론적으로, 테스트 피라미드는 빠르고 정확한 피드백을 자주 얻고, 전체 시스템에 대한 신뢰도를 비용 효율적으로 확보하기 위한 최적의 균형점을 제시하는 매우 중요한 전략입니다.

---
**다음 세션**: [03. TDD 소개](../03-intro-to-tdd/README.md)
